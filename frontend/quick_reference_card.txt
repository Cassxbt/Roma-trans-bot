# ğŸš€ Voice Translation Quick Reference

**Roma Translation Bot - Voice Features Cheat Sheet**

---

## âš¡ 5-Minute Setup

```bash
# 1. Get HF token: https://huggingface.co/settings/tokens
# 2. Add to .env:
HF_TOKEN=hf_your_token_here

# 3. Install dependencies:
pip install requests python-dotenv

# 4. Create service file:
# Copy hf_whisper_service.py to src/services/

# 5. Test:
python -c "from src.services.hf_whisper_service import HFWhisperASR; print('âœ… Ready!')"
```

---

## ğŸ“± How Users Send Voice Notes

### Discord
```
1. Upload audio file OR record voice note
2. Type: !voicetrans chinese french korean
3. Get instant translation
```

### Telegram
```
1. Hold ğŸ¤ button in chat
2. Speak message
3. Release button
4. Auto-translates (no command needed!)
```

---

## ğŸ¯ Commands Reference

### Discord Commands

| Command | Description | Example |
|---------|-------------|---------|
| `!voicetrans <langs>` | Translate voice to multiple languages | `!voicetrans chinese french` |
| `!vt <langs>` | Short alias for voicetrans | `!vt korean turkish` |
| `!voicehelp` | Show voice commands help | `!voicehelp` |

**Usage:**
```
User: [uploads voice file]
User: !voicetrans chinese french korean
Bot: 
  ğŸ“ Original: Hello, how are you?
  ğŸ‡¨ğŸ‡³ Chinese: ä½ å¥½ï¼Œä½ å¥½å—ï¼Ÿ
  ğŸ‡«ğŸ‡· French: Bonjour, comment allez-vous?
  ğŸ‡°ğŸ‡· Korean: ì•ˆë…•í•˜ì„¸ìš”, ì–´ë–»ê²Œ ì§€ë‚´ì„¸ìš”?
```

### Telegram Commands

| Command | Description | Example |
|---------|-------------|---------|
| `/voicetrans <langs>` | Set target languages | `/voicetrans chinese french` |
| [Voice Note] | Auto-translates voice note | Just send voice note! |

**Usage:**
```
User: [sends voice note]
Bot:
  ğŸ™ï¸ Transcribing your voice message...
  ğŸ“ You said: Hello, how are you?
  
  Translations:
  ğŸ‡¨ğŸ‡³ Chinese: ä½ å¥½ï¼Œä½ å¥½å—ï¼Ÿ
  ğŸ‡«ğŸ‡· French: Bonjour, comment allez-vous?
  ğŸ‡°ğŸ‡· Korean: ì•ˆë…•í•˜ì„¸ìš”, ì–´ë–»ê²Œ ì§€ë‚´ì„¸ìš”?
```

---

## ğŸŒ Supported Languages

Current Implementation:
- ğŸ‡¨ğŸ‡³ **Chinese** (chinese)
- ğŸ‡¬ğŸ‡§ **English** (english)
- ğŸ‡«ğŸ‡· **French** (french)
- ğŸ‡¹ğŸ‡· **Turkish** (turkish)
- ğŸ‡°ğŸ‡· **Korean** (korean)

**Note:** Whisper supports 99 languages total. Add more anytime!

---

## ğŸµ Supported Audio Formats

âœ… WAV  
âœ… MP3  
âœ… M4A  
âœ… FLAC  
âœ… OGG  
âœ… OPUS (Telegram voice notes)

**Recommended:** 
- Keep audio under 30 seconds
- Clear speech, minimal background noise
- Use voice notes (not file attachments) in Telegram

---

## ğŸ“Š Performance

| Metric | Value |
|--------|-------|
| First transcription | 30-60 seconds (cold start) |
| Cached transcription | <100ms (instant) |
| Regular transcription | 2-5 seconds |
| Translation | 2-5 seconds |
| Total time | 4-10 seconds (after cold start) |

**Rate Limits (Free Tier with Token):**
- ~200-300 requests per hour
- ~5,000-10,000 requests per month
- Resets every hour

---

## ğŸ”§ Code Integration

### Discord Bot

```python
from src.services.hf_whisper_service import HFWhisperASR
import tempfile
import os

class TranslationBot(commands.Bot):
    def __init__(self):
        super().__init__(command_prefix='!', intents=discord.Intents.all())
        self.asr = HFWhisperASR(enable_cache=True)
        self.translation_agent = TranslationAgent()
    
    @commands.command(name='voicetrans')
    async def voice_translate(self, ctx, *languages):
        if not ctx.message.attachments:
            await ctx.send("âŒ Attach audio file!")
            return
        
        attachment = ctx.message.attachments[0]
        
        # Download audio
        with tempfile.NamedTemporaryFile(delete=False, suffix='.wav') as tmp:
            await attachment.save(tmp.name)
            audio_path = tmp.name
        
        try:
            # Transcribe
            result = self.asr.transcribe_with_retry(audio_path)
            if not result['success']:
                await ctx.send(f"âŒ Error: {result['error']}")
                return
            
            # Translate
            translations = await self.translation_agent.translate(
                text=result['text'],
                target_languages=list(languages)
            )
            
            # Send results
            # ... format and send
        finally:
            os.unlink(audio_path)
```

### Telegram Bot

```python
from src.services.hf_whisper_service import HFWhisperASR
import tempfile

asr = HFWhisperASR(enable_cache=True)

async def handle_voice_message(update: Update, context):
    # Download voice note
    voice = await update.message.voice.get_file()
    
    with tempfile.NamedTemporaryFile(delete=False, suffix='.ogg') as tmp:
        await voice.download_to_drive(tmp.name)
        audio_path = tmp.name
    
    try:
        # Transcribe
        result = asr.transcribe_with_retry(audio_path)
        
        if result['success']:
            # Translate
            translations = translation_agent.translate(
                text=result['text'],
                target_languages=['Chinese', 'French', 'Korean']
            )
            # Send results
        else:
            await update.message.reply_text(f"âŒ Error: {result['error']}")
    finally:
        os.unlink(audio_path)

# Register handler
app.add_handler(MessageHandler(filters.VOICE, handle_voice_message))
```

---

## ğŸ› Common Issues & Fixes

### "Model loading" (503 Error)
**Cause:** Cold start (first request)  
**Fix:** Wait 30-60s and retry (automatic with `transcribe_with_retry()`)

### "Rate limit exceeded" (429 Error)
**Cause:** Too many requests  
**Fix:** 
- With token: Wait 1 hour
- Without token: Add `HF_TOKEN` to `.env`
- Upgrade to HF Pro ($9/mo) for unlimited

### "HF_TOKEN not found"
**Cause:** Token not in `.env`  
**Fix:**
```bash
# Add to .env
HF_TOKEN=hf_your_token_here

# Restart bot
python run_discord_bot.py
```

### Telegram voice notes not working
**Cause:** Sending audio files instead of voice notes  
**Fix:** Use the ğŸ¤ microphone button (bottom right of chat), NOT file attachment

### Discord not recognizing audio
**Cause:** File format not supported  
**Fix:** Convert to WAV, MP3, or M4A

---

## ğŸ’¾ Caching

**How it works:**
1. Audio file is hashed (MD5)
2. Check if hash exists in cache
3. If yes: Return cached result instantly
4. If no: Transcribe and cache result

**Clear cache:**
```python
from src.services.hf_whisper_service import HFWhisperASR
asr = HFWhisperASR()
asr.clear_cache()
```

**Check cache stats:**
```python
asr = HFWhisperASR()
print(asr.get_cache_stats())
```

---

## ğŸ§ª Testing Commands

```bash
# Test setup
python -c "from src.services.hf_whisper_service import HFWhisperASR; print('âœ…')"

# Test with audio file
python -c "
from src.services.hf_whisper_service import HFWhisperASR
asr = HFWhisperASR()
result = asr.transcribe_with_retry('test_voice.wav')
print(result)
"

# Check environment
python -c "
import os
from dotenv import load_dotenv
load_dotenv()
print('HF_TOKEN:', 'Set' if os.getenv('HF_TOKEN') else 'Missing')
"

# Run Discord bot
python run_discord_bot.py

# Run Telegram bot
python run_telegram_bot.py
```

---

## ğŸ“ File Structure

```
Roma-trans-bot/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ hf_whisper_service.py    # â† NEW: ASR service
â”‚   â”œâ”€â”€ bots/
â”‚   â”‚   â”œâ”€â”€ discord_bot.py           # â† MODIFIED: Add voice commands
â”‚   â”‚   â””â”€â”€ telegram_bot.py          # â† MODIFIED: Add voice handler
â”‚   â””â”€â”€ core/
â”‚       â””â”€â”€ translation_agent.py     # â† EXISTING: ROMA translation
â”œâ”€â”€ .env                              # â† MODIFIED: Add HF_TOKEN
â”œâ”€â”€ requirements.txt                  # â† MODIFIED: Add requests
â””â”€â”€ asr_cache.json                    # â† AUTO-CREATED: Transcription cache
```

---

## ğŸ¯ Best Practices

1. âœ… **Always use `transcribe_with_retry()`** - Handles cold starts automatically
2. âœ… **Enable caching** - Reduces API calls by 40%+
3. âœ… **Use temporary files** - Clean up after processing
4. âœ… **Validate audio formats** - Check file extensions before processing
5. âœ… **Handle errors gracefully** - Show user-friendly error messages
6. âœ… **Log everything** - Track API calls and errors
7. âœ… **Test with short clips first** - Verify setup before production

---

## ğŸ“ˆ Monitoring

**Track these metrics:**
- Transcription success rate
- Average response time
- Cache hit rate
- API errors (429, 503)
- User satisfaction

**Log important events:**
```python
print(f"ğŸ™ï¸ Transcribing: {filename}")
print(f"âœ… Success: {result['text'][:50]}...")
print(f"ğŸ’¾ Cached: {result.get('cached', False)}")
print(f"â±ï¸ Time: {elapsed_time}s")
```

---

## ğŸ”— Useful Links

- **HF Token:** https://huggingface.co/settings/tokens
- **HF Status:** https://status.huggingface.co
- **Whisper Model:** https://huggingface.co/openai/whisper-large-v3
- **ROMA Framework:** https://github.com/sentient-agi/roma
- **Discord.py Docs:** https://discordpy.readthedocs.io
- **Telegram Bot API:** https://docs.python-telegram-bot.org

---

## ğŸ’¡ Pro Tips

1. **First deployment?** Test with a 5-second audio clip
2. **Hitting rate limits?** Add `HF_TOKEN` for 10x more requests
3. **Slow transcription?** First request is slow (cold start), then fast
4. **Want faster?** Enable caching (enabled by default)
5. **Need more languages?** Whisper supports 99 - just add to your list
6. **Production deployment?** Consider HF Pro ($9/mo) for unlimited requests
7. **Debugging?** Check bot logs for detailed error messages

---

## ğŸ“ Support

**Having issues?**

1. Check logs for error messages
2. Verify `HF_TOKEN` is set correctly
3. Test ASR service independently
4. Check HuggingFace status page
5. Review troubleshooting section in main guide

**Common success checks:**
```bash
âœ… HF_TOKEN exists in .env
âœ… Dependencies installed (requests, python-dotenv)
âœ… hf_whisper_service.py in src/services/
âœ… Bot code modified with voice handlers
âœ… Test audio transcribes successfully
âœ… Translations work after transcription
```

---

## ğŸ‰ Success Indicators

You'll know it's working when:

- âœ… Discord bot responds to `!voicetrans`
- âœ… Telegram auto-processes voice notes
- âœ… Transcriptions are accurate
- âœ… Translations appear in all target languages
- âœ… Cached results return instantly
- âœ… No error messages in logs

---

**Version:** 1.0  
**Last Updated:** 2024  
**Maintained by:** Roma Translation Bot Team

For detailed setup, see `VOICE_TRANSLATION_SETUP.md`
